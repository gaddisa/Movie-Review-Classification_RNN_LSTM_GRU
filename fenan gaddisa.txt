<?php

namespace App\Livewire\PaymentReport;

use Livewire\Component;
use Livewire\WithPagination;
use App\Models\Payment;
use App\Models\PaymentAllocation;
use App\Models\RentAgreement;
use Modules\Site\Models\Site;
use LivewireUI\Modal\ModalComponent;
use Illuminate\Support\Facades\Auth;
use Spatie\Permission\Models\Role;
use Carbon\Carbon;

class PendingPayments extends Component
{
    use WithPagination;

    public $startYear;
    public $endYear;
    public $startMonth;
    public $endMonth;
    public $siteId;
    public $sites = [];
    public $filtersApplied = false;
    public $totalPendingAmount = 0;
    public $useDateFilters = false; // New property to toggle date filters

    protected $paginationTheme = 'bootstrap';
    protected $listeners = ['payment-approved' => '$refresh'];

    public function mount()
    {
        $this->sites = Site::all();
        $this->setDefaultDateRange();
    }

    protected function setDefaultDateRange()
    {
        $currentDate = now();
        $this->startYear = 2024; // Default to 2024
        $this->startMonth = 7;   // Default to July
        $this->endYear = $currentDate->year;
        $this->endMonth = $currentDate->month;
    }

    public function toggleDateFilters()
    {
        $this->useDateFilters = !$this->useDateFilters;
        $this->resetPage();
    }

    public function applyFilters()
    {
        $this->filtersApplied = true;
        $this->resetPage();
    }

    public function resetFilters()
    {
        $this->reset(['siteId', 'filtersApplied', 'useDateFilters']);
        $this->setDefaultDateRange();
        $this->resetPage();
    }

    public function render()
    {
        $user = Auth::user();
        $query = PaymentAllocation::query()
            ->where('status', 'pending')
            ->with(['payment', 'agreement.room.site', 'agreement.tenant', 'payment.updater.roles']);

        // Apply date filters only if enabled and filters are applied
        if ($this->useDateFilters && $this->filtersApplied) {
            $query->where(function($q) {
                $q->where(function($q1) {
                    $q1->where('year_gregorian', '>', $this->startYear)
                       ->orWhere(function($q2) {
                           $q2->where('year_gregorian', $this->startYear)
                              ->where('month_gregorian', '>=', $this->startMonth);
                       });
                })
                ->where(function($q1) {
                    $q1->where('year_gregorian', '<', $this->endYear)
                       ->orWhere(function($q2) {
                           $q2->where('year_gregorian', $this->endYear)
                              ->where('month_gregorian', '<=', $this->endMonth);
                       });
                });
            });
        }

        if ($this->siteId) {
            $query->whereHas('agreement.room', function ($q) {
                $q->where('site_id', $this->siteId);
            });
        }

        // Role-based filtering
        if ($user->hasRole('tenant')) {
            // Tenants see only their own pending payments
            $query->whereHas('agreement.tenant', function ($q) use ($user) {
                $q->where('user_id', $user->id);
            });
        } elseif ($user->hasRole('cashier')) {
            // Cashiers see payments submitted by tenants (not yet approved by cashier)
            $query->whereHas('payment.updater.roles', function ($q) {
                $q->where('name', 'tenant');
            });
        } elseif ($user->hasAnyRole(['super admin', 'deputy director','ceo'])) {
            // For super admin: show both payments approved by cashiers AND payments not yet approved by anyone
            if ($user->hasRole('super admin')) {
                $query->where(function($q) use ($user) {
                    // Payments approved by cashiers (waiting for admin approval)
                    $q->whereHas('payment.updater.roles', function ($q) {
                        $q->where('name', 'cashier');
                    })
                    // OR payments not yet approved by anyone (still with tenant)
                    ->orWhereHas('payment.updater.roles', function ($q) {
                        $q->where('name', 'tenant');
                    });
                });
            } else {
                // For deputy director and CEO: only show payments approved by cashiers
                $query->whereHas('payment.updater.roles', function ($q) {
                    $q->where('name', 'cashier');
                });
            }
        }

        // Optional: Add payment status check to ensure we only show truly pending payments
        $query->whereHas('payment', function ($q) {
            $q->where('status', 'pending');
        });

        $allocations = $query->paginate(25);
        $this->totalPendingAmount = $query->sum('total_for_the_month');

        return view('livewire.payment-report.pending-payments', [
            'allocations' => $allocations,
            'totalPendingAmount' => $this->totalPendingAmount,
            'user' => $user,
        ]);
    }

    public function openApprovalModal($paymentId)
    {
        $this->dispatch('openModal', 'payment-report.payment-approval-modal', ['paymentId' => $paymentId]);
    }
}
