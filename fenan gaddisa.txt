@extends('backend.layouts.app')


@section('title', 'Answer Questions')


@section('breadcrumbs')

    <x-backend.breadcrumbs>

        <x-backend.breadcrumb-item route="{{ route('backend.applications.index') }}" icon="fa-solid fa-folder">

            {{ __('Applications') }}

        </x-backend.breadcrumb-item>

        <x-backend.breadcrumb-item route="{{ route('backend.applications.standards', ['id' => $application_id]) }}"

            icon="fa-solid fa-list">

            {{ __('Standards') }}

        </x-backend.breadcrumb-item>

        <x-backend.breadcrumb-item type="active">{{ __('Answer Questions') }}</x-backend.breadcrumb-item>

    </x-backend.breadcrumbs>

@endsection


@section('content')

    <div class="card">




        <!-- Notification Section -->

        <div class="alert alert-warning alert-dismissible fade show mb-3">

            <strong>Important!</strong> Before answering DCT questions below, please ensure all required attachments at the

            bottom are

            uploaded.

            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>

        </div>


        <div class="card-header bg-primary text-white">

            <h4 class="mb-0">{{ $standard->name }}</h4>

        </div>

        <div class="card-body">

            <p class="text-muted">Answer the questions for each indicator under the respective substandard.</p>


            @if ($substandards->isNotEmpty())

                <div class="card mb-3">

                    <div class="card-header bg-secondary text-white">

                        <h5 class="mb-0">{{ $currentSubStandard->name }}</h5>

                    </div>

                    <div class="card-body">

                        @if ($indicators->isNotEmpty())

                            <div class="card mb-3">

                                <div class="card-header bg-info text-white">

                                    <h6 class="mb-0">{{ $currentIndicator->name }}</h6>

                                </div>

                                <div class="card-body">

                                    <form method="POST" action="{{ route('backend.applications.submitAnswers') }}"

                                        enctype="multipart/form-data" id="questionForm">

                                        @csrf

                                        <input type="hidden" name="application_id" value="{{ $application_id }}">

                                        <input type="hidden" name="standard_id" value="{{ $standard_id }}">

                                        <input type="hidden" name="substandard_id" value="{{ $currentSubStandard->id }}">

                                        <input type="hidden" name="indicator_id" value="{{ $currentIndicator->id }}">


                                        @foreach ($questions as $question)

                                            <div class="card mb-3">

                                                <div class="card-header bg-light">

                                                    <h6 class="mb-0">

                                                        <i class="fa-solid fa-question-circle text-primary"></i>

                                                        {{ $question->question_text }}

                                                    </h6>

                                                </div>

                                                <div class="card-body">

                                                    <textarea name="answers[{{ $question->id }}][answer]" class="form-control summernote" required>

                                    {{ old("answers.$question->id.answer", $answers[$question->id] ?? '') }}

                                    </textarea>

                                                    <input type="hidden" name="answers[{{ $question->id }}][question_id]"

                                                        value="{{ $question->id }}">

                                                </div>

                                            </div>

                                        @endforeach


                                        {{-- Required Attachments Table --}}

                                        @if ($attachments->isNotEmpty())

                                            <div class="card mt-4">

                                                <div class="card-header bg-warning text-dark">

                                                    <h6 class="mb-0">Required Attachments</h6>

                                                </div>

                                                <div class="card-body">

                                                    {{-- Notice Section --}}

                                                    <div class="alert alert-info p-3 rounded">

                                                        <strong>Important:</strong>

                                                        <ul class="mb-0">

                                                            <li>All attachments must be in <strong>PDF format</strong>.</li>

                                                            <li>Some attachments require you to specify the <b>exact page

                                                                    number </b>where the table begins. When asked, please

                                                                provide

                                                                this information.</li>

                                                        </ul>

                                                    </div>


                                                    <table class="table table-bordered shadow-sm">

                                                        <thead class="table-light">

                                                            <tr>

                                                                <th style="width: 5%;" class="text-center">#</th>

                                                                <th style="width: 55%;">Attachment</th>

                                                                <th style="width: 20%;" class="text-center">Status</th>

                                                                <th style="width: 20%;" class="text-center">Action</th>

                                                            </tr>

                                                        </thead>

                                                        <tbody>

                                                            @foreach ($attachments as $index => $attachment)

                                                                <tr class="align-middle">

                                                                    

                                                                    <td class="text-center fw-bold">{{ $index + 1 }}

                                                                    </td>

                                                                  <td>

                                                            @php

                                                                $cleanName = preg_replace('/ - Indicator \d+$/', '', $attachment->name ?? '');

                                                            @endphp

                                                        

                                                            {{ $cleanName ?: 'No File' }} 

                                                            @if($cleanName === 'Others')

                                                                (Optional)

                                                            @endif

                                                        </td>


                                                                    <td class="text-center">

                                                                        <span

                                                                            class="badge rounded-pill {{ $attachment->status === 'Completed' ? 'bg-success text-white' : 'bg-danger text-white' }} px-3 py-2">

                                                                            @if ($attachment->status === 'Completed')

                                                                                <i class="fas fa-check-circle"></i>

                                                                                {{ $attachment->status }}

                                                                            @else

                                                                                <i class="fas fa-times-circle"></i>

                                                                                {{ $attachment->status }}

                                                                            @endif

                                                                        </span>


                                                                        @if ($attachment->status === 'Completed')

                                                                            <div class="mt-2">

                                                                                <button type="button"

                                                                                    class="btn btn-outline-success btn-sm view-pdf"

                                                                                    data-bs-toggle="modal"

                                                                                    data-bs-target="#pdfModal{{ $attachment->id }}"

                                                                                    data-pdf-url="{{ route('backend.applications.viewMedia', ['application_id' => $application_id, 'attachment_id' => $attachment->id]) }}#page={{ $attachment->start_page ?? 1 }}"

                                                                                    data-start-page="{{ $attachment->start_page ?? 1 }}">

                                                                                    <i class="fas fa-file-pdf"></i> View

                                                                                </button>

                                                                            </div>

                                                                        @endif

                                                                    </td>

                                                                    <td class="text-center">

                                                                        <button type="button"

                                                                            class="btn btn-outline-primary btn-sm"

                                                                            data-bs-toggle="modal"

                                                                            data-bs-target="#uploadModal{{ $attachment->id }}">

                                                                            <i class="fas fa-upload"></i>

                                                                            {{ $attachment->status === 'Completed' ? 'Reupload' : 'Upload' }}

                                                                        </button>

                                                                    </td>

                                                                </tr>

                                                            @endforeach

                                                        </tbody>

                                                    </table>



                                                    @foreach ($attachments as $attachment)

                                                        @if ($attachment->status === 'Completed')

                                                            <!-- PDF Viewer Modal -->

                                                            <div class="modal fade" id="pdfModal{{ $attachment->id }}"

                                                                tabindex="-1"

                                                                aria-labelledby="pdfModalLabel{{ $attachment->id }}"

                                                                aria-hidden="true">

                                                                <div class="modal-dialog modal-dialog-centered modal-xl">

                                                                    <div class="modal-content shadow-lg">

                                                                        <div class="modal-header bg-primary text-white">

                                                                            <h5 class="modal-title"

                                                                                id="pdfModalTitle{{ $attachment->id }}">

                                                                                <i class="fas fa-file-pdf"></i> ETA

                                                                                Accreditation System:

                                                                                {{ $attachment->name ?? 'No File' }}

                                                                            </h5>

                                                                            <button type="button" class="btn-close"

                                                                                data-bs-dismiss="modal"

                                                                                aria-label="Close"></button>

                                                                        </div>

                                                                        <div class="modal-body">

                                                                            <!-- Responsive iframe to view PDF -->

                                                                            <iframe id="pdfViewer{{ $attachment->id }}"

                                                                                src="{{ route('backend.applications.viewMedia', ['application_id' => $application_id, 'attachment_id' => $attachment->id]) }}?page={{ $attachment->start_page ?? 1 }}"

                                                                                width="100%" height="600px"

                                                                                frameborder="0">

                                                                            </iframe>




                                                                        </div>

                                                                    </div>

                                                                </div>

                                                            </div>

                                                        @endif

                                                    @endforeach


                                                    <script>

                                                        document.addEventListener('DOMContentLoaded', function() {

                                                            document.querySelectorAll('.view-pdf').forEach(function(button) {

                                                                button.addEventListener('click', function() {

                                                                    var pdfUrl = this.getAttribute('data-pdf-url');

                                                                    var modalId = this.getAttribute('data-bs-target').replace('#', '');

                                                                    document.querySelector('#' + modalId + ' iframe').setAttribute('src', pdfUrl);

                                                                });

                                                            });

                                                        });

                                                    </script>




                                                </div>

                                            </div>

                                        @endif



                                        <div class="d-flex justify-content-between mt-3">

                                            @if ($currentIndicator->id != $indicators->first()->id)

                                                <button type="submit" name="direction" value="previous"

                                                    class="btn btn-warning btn-sm">

                                                    <i class="fas fa-reply"></i> Previous

                                                </button>

                                            @endif


                                            <a href="{{ route('backend.applications.standards', ['id' => $application_id]) }}"

                                                class="btn btn-warning btn-sm" data-bs-toggle="tooltip"

                                                title="{{ __('Go Back') }}">

                                                <i class="fas fa-reply"></i>

                                                &nbsp;{{ __('Back') }}

                                            </a>




                                            <button type="submit" name="direction" value="next"

                                                class="btn btn-primary">

                                                <i class="fa fa-save"></i> Save & Next

                                            </button>



                                        </div>

                                    </form>


                                </div>

                            </div>

                            @foreach ($attachments as $attachment)

                                <div class="modal fade" id="uploadModal{{ $attachment->id }}" tabindex="-1"

                                    aria-labelledby="uploadModalLabel{{ $attachment->id }}" aria-hidden="true">

                                    <div class="modal-dialog modal-dialog-centered modal-lg">

                                        <div class="modal-content">

                                            <div class="modal-header bg-primary text-white">

                                                <h5 class="modal-title" id="uploadModalLabel{{ $attachment->id }}">Upload

                                                    {{ $attachment->name }}

                                                </h5>

                                                <button type="button" class="btn-close" data-bs-dismiss="modal"

                                                    aria-label="Close"></button>

                                            </div>

                                            <div class="modal-body">

                                                <form method="POST"

                                                    action="{{ route('backend.applications.uploadMedia', $application_id) }}"

                                                    enctype="multipart/form-data"

                                                    id="uploadAttachmentForm{{ $attachment->id }}">

                                                    @csrf

                                                    <!-- Hidden Fields -->

                                                    <input type="hidden" name="attachment_id"

                                                        value="{{ $attachment->id }}">

                                                    <input type="hidden" name="application_id"

                                                        value="{{ $application_id }}">

                                                    <input type="hidden" name="indicator_id"

                                                        value="{{ $currentIndicator->id }}">


                                                    <div class="mb-3">

                                                        <label class="form-label">Select File (PDF only)</label>

                                                        <input type="file" class="form-control attachment-file"

                                                            name="attachment_file"

                                                            id="attachmentFile{{ $attachment->id }}"

                                                            accept="application/pdf" required>

                                                        <div id="fileError{{ $attachment->id }}" class="text-danger mt-2"

                                                            style="display: none;"></div>

                                                    </div>


                                                    @if ($attachment->attachement_type === 'TABLE')

                                                        <div class="mb-3">

                                                            <label class="form-label">Enter Page Number</label>

                                                            <input type="number" class="form-control" name="page_number"

                                                                min="1" required>

                                                            <small class="text-muted">

                                                                As per the DCT Guideline, please specify the exact page

                                                                number where the table containing the response to the

                                                                question begins in the attached document.

                                                                Note that the page number should be counted from the first

                                                                page of the document, not the printed or written page

                                                                number.

                                                                Refer to the DCT Guideline of your program for further

                                                                clarification.


                                                            </small>

                                                        </div>

                                                    @endif


                                                    <div class="text-end">

                                                        <button type="submit" class="btn btn-success">Upload</button>

                                                    </div>

                                                </form>

                                            </div>

                                        </div>

                                    </div>

                                </div>

                            @endforeach


                            <script>

                                document.addEventListener('DOMContentLoaded', function() {

                                    document.querySelectorAll('.attachment-file').forEach(fileInput => {

                                        const id = fileInput.id.replace('attachmentFile', '');

                                        const fileError = document.getElementById(`fileError${id}`);

                                        const form = document.getElementById(`uploadAttachmentForm${id}`);


                                        fileInput.addEventListener('change', function(event) {

                                            const file = event.target.files[0];

                                            const allowedTypes = ['application/pdf'];

                                            const maxSize = 25 * 1024 * 1024; // 8MB in bytes


                                            if (file) {

                                                if (!allowedTypes.includes(file.type)) {

                                                    fileError.textContent = 'Invalid file type. Please upload a PDF file.';

                                                    fileError.style.display = 'block';

                                                    fileInput.value = ''; // Clear the file input

                                                    return;

                                                }

                                                if (file.size > maxSize) {

                                                    fileError.textContent =

                                                        'File size exceeds 25MB. Please upload a smaller file.';

                                                    fileError.style.display = 'block';

                                                    fileInput.value = ''; // Clear the file input

                                                    return;

                                                }

                                            }


                                            fileError.style.display = 'none'; // Hide the error message if validation passes

                                        });


                                        form.addEventListener('submit', function(event) {

                                            const file = fileInput.files[0];

                                            if (file) {

                                                if (!allowedTypes.includes(file.type)) {

                                                    event.preventDefault(); // Prevent form submission

                                                    fileError.textContent = 'Invalid file type. Please upload a PDF file.';

                                                    fileError.style.display = 'block';

                                                    return;

                                                }

                                                if (file.size > maxSize) {

                                                    event.preventDefault(); // Prevent form submission

                                                    fileError.textContent =

                                                        'File size exceeds 25MB. Please upload a smaller file.';

                                                    fileError.style.display = 'block';

                                                    return;

                                                }

                                            }

                                        });

                                    });

                                });

                            </script>

                        @else

                            <p class="alert alert-warning">No indicators found for this substandard.</p>

                        @endif

                    </div>

                </div>

            @else

                <p class="alert alert-danger">No substandards found for this standard.</p>

            @endif

        </div>

    </div>


    <!-- Navigation Confirmation Modal -->

    <div class="modal fade" id="confirmNavigationModal" tabindex="-1" aria-hidden="true">

        <div class="modal-dialog">

            <div class="modal-content">

                <div class="modal-header">

                    <h5 class="modal-title">Confirm Navigation</h5>

                </div>

                <div class="modal-body">Are you sure you want to navigate without saving?</div>

                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                    <button type="button" class="btn btn-primary" id="confirmNavBtn">Proceed</button>

                </div>

            </div>

        </div>

    </div>


    <!-- Missing Attachments Modal -->

    <div class="modal fade" id="missingAttachmentsModal" tabindex="-1" aria-hidden="true">

        <div class="modal-dialog">

            <div class="modal-content">

                <div class="modal-header bg-danger text-white">

                    <h5 class="modal-title">Missing Attachments</h5>

                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                </div>

                <div class="modal-body">

                    <p>The following required attachments are missing:</p>

                    <ul id="missingAttachmentsList"></ul>

                </div>

                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                </div>

            </div>

        </div>

    </div>


    <script>

document.addEventListener('DOMContentLoaded', function() {

    const form = document.querySelector('form[action="{{ route('backend.applications.submitAnswers') }}"]');

    

    form.addEventListener('submit', function(event) {

        // Get all attachments data from server-side (passed from controller)

        const attachments = @json($attachments);

        

        // Check only mandatory attachments that are not uploaded

        const missingMandatoryAttachments = attachments.filter(attachment => 

            attachment.is_required === 'Mandatory' && attachment.status !== 'Completed'

        );

        

        // If mandatory attachments are missing, prevent form submission

        if (missingMandatoryAttachments.length > 0) {

            event.preventDefault();

            

            // Populate the modal with missing mandatory attachments

            const missingAttachmentsList = document.getElementById('missingAttachmentsList');

            missingAttachmentsList.innerHTML = missingMandatoryAttachments.map(attachment =>

                `<li>${attachment.name}</li>`

            ).join('');

            

            // Show the modal

            const modal = new bootstrap.Modal(document.getElementById('missingAttachmentsModal'));

            modal.show();

            

            // Scroll to the attachments section

            document.querySelector('.card-header.bg-warning').scrollIntoView({

                behavior: 'smooth'

            });

        }

    });

});    


</script>

@endsection




@push('after-styles')

    <link href="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-lite.min.css" rel="stylesheet" />

    <style>

        .note-editor.note-frame:after {

            display: none;

        }


        .note-editor .note-toolbar .note-dropdown-menu,

        .note-popover .popover-content .note-dropdown-menu {

            min-width: 180px;

        }


        /* Fix Summernote fullscreen */

        .modal-open .note-editor {

            z-index: 1050 !important;

        }

    </style>

@endpush


@push('after-scripts')

    <script src="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-lite.min.js"></script>


    <script>

        $(document).ready(function() {

            $('.summernote').summernote({

                height: 300,

                toolbar: [

                    ['style', ['bold', 'italic', 'underline', 'clear']],

                    ['para', ['ul', 'ol', 'paragraph']],

                    ['insert', ['link']]

                ],

                callbacks: {

                    onInit: function() {

                        // Properly decode HTML entities when initializing

                        var content = $(this).summernote('code');

                        $(this).summernote('code', $('<div/>').html(content).text());

                    },

                    onPaste: function(e) {

                        // Clean pasted content

                        var bufferText = ((e.originalEvent || e).clipboardData || window.clipboardData)

                            .getData('Text');

                        e.preventDefault();

                        document.execCommand('insertText', false, bufferText);

                    }

                }

            });


            // Ensure Fullscreen Works Properly

            $(document).on('click', '.note-btn.fullscreen', function() {

                setTimeout(function() {

                    $(".note-editable").css("height", $(window).height() - 150 + "px");

                }, 500);

            });

        });

    </script>



    <script>

        function previewAttachment(event, id) {

            const file = event.target.files[0];

            if (file) {

                document.getElementById('previewBtn' + id).style.display = 'inline-block';

                const url = URL.createObjectURL(file);

                document.getElementById('attachmentPreview').src = url;

            }

        }


        function confirmNavigation(direction) {

            $('#confirmNavigationModal').modal('show');

            document.getElementById('confirmNavBtn').onclick = function() {

                document.getElementById('questionForm').submit();

            };

        }

    </script>

@endpush

