<?php

namespace Modules\DCT\Http\Controllers\Backend;

use App\Authorizable;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Modules\Program\Models\Program;
use RealRashid\SweetAlert\Facades\Alert;
use App\Http\Controllers\Backend\BackendBaseController;
use Illuminate\Support\Facades\DB;

class DCTSController extends BackendBaseController
{
    use Authorizable;

    public function __construct()
    {
        // Page Title
        $this->module_title = 'DCTS';

        // module name
        $this->module_name = 'dcts';

        // directory path of the module
        $this->module_path = 'dct::backend';

        // module icon
        $this->module_icon = 'fa-regular fa-sun';

        // module model name, path
        $this->module_model = "Modules\DCT\Models\DCT";
    }

    // Override the index_data method to include additional buttons
    // Override the index_data method to include additional buttons
    public function index_data(?array $columns = null, array $additionalButtons = [], array $additionalData = [])
    {
        $buttonModuleName = 'standards';
        $additionalButtons = [
            [
                'route' => "backend.$buttonModuleName.standards", // Matches the route name
                'title' => 'Standards',
                'class' => 'btn-outline-info',
                'icon' => 'fa-solid fa-sitemap',
            ],
            [
    'route' => "backend.applications.downloadDctStructure",
    'title' => 'Download Structure',
    'class' => 'btn-outline-primary',
    'icon' => 'fa-solid fa-download',
],
        ];

        return parent::index_data($columns, $additionalButtons);
    }

    public function store(Request $request)
    {
        $module_title = $this->module_title;
        $module_name = $this->module_name;
        $module_model = $this->module_model;
        $module_action = 'Store';

        // Validate request input
        $validatedData = $request->validate([
            'program_id' => 'required|exists:programs,id'
        ]);

        // Fetch the program
        $program = Program::findOrFail($validatedData['program_id']);
        $name = 'DCT-' . Str::slug($program->description); // Ensure safe name format

        // Ensure name is unique
        if ($module_model::where('name', $name)->exists()) {
            return back()->withErrors(['name' => 'The generated name already exists.'])->withInput();
        }

        // Use a database transaction for consistency
        DB::beginTransaction();
        try {
            $record = $module_model::create([
                'name' => $name,
                'program_id' => $program->id
            ]);

            DB::commit();

            // Log the action
            logUserAccess($module_title . ' ' . $module_action . ' | Id: ' . $record->id);

            // Notification
            Alert::toast(Str::singular($module_title) . ' Added Successfully', 'success')
                ->position('top-end')
                ->autoClose(5000)
                ->timerProgressBar();

            return redirect("admin/{$module_name}");
        } catch (\Exception $e) {
            DB::rollBack();
            report($e);
            return back()->withErrors(['error' => 'An error occurred while processing your request.']);
        }
    }

    public function update(Request $request, $id)
    {
        $module_title = $this->module_title;
        $module_name = $this->module_name;
        $module_model = $this->module_model;
        $module_action = 'Update';

        // Validate request input
        $validatedData = $request->validate([
            'program_id' => 'required|exists:programs,id'
        ]);

        // Find the existing record
        $record = $module_model::findOrFail($id);

        // Fetch the new program details
        $program = Program::findOrFail($validatedData['program_id']);
        $newName = 'DCT-' . Str::slug($program->description);

        // Ensure unique name (skip if it's the same as current)
        if ($record->name !== $newName && $module_model::where('name', $newName)->exists()) {
            return back()->withErrors(['name' => 'The generated name already exists.'])->withInput();
        }

        // Use a database transaction for safety
        DB::beginTransaction();
        try {
            $record->update([
                'name' => $newName,
                'program_id' => $program->id
            ]);

            DB::commit();

            // Log the action
            logUserAccess($module_title . ' ' . $module_action . ' | Id: ' . $record->id);

            // Notification
            Alert::toast(Str::singular($module_title) . ' Updated Successfully', 'success')
                ->position('top-end')
                ->autoClose(5000)
                ->timerProgressBar();

            return redirect("admin/{$module_name}");
        } catch (\Exception $e) {
            DB::rollBack();
            report($e);
            return back()->withErrors(['error' => 'An error occurred while updating the record.']);
        }
    }



    // public function standards($id)
    // {
    //     // Redirect to StandardsController's standards2 method with the ID
    //     return redirect()->route('backend.dcts.viewstandardlists', ['id' => $id]);
    // }
}
